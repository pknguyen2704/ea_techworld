name: CI Build & Push Magento & Elasticsearch

on:
  push:
    branches: [ "main" ]

env:
  PROJECT_ID: enterprise-452702
  REGION: asia-southeast1
  REGISTRY: gcr.io

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout source code
      uses: actions/checkout@v3

    - name: Authenticate with GCP
      uses: google-github-actions/auth@v2
      with:
        credentials_json: '${{ secrets.GCP_SA_KEY }}'

    - name: Configure Docker for GCR
      run: gcloud auth configure-docker gcr.io

    - name: Prepare Magento source code (for PHP-FPM image)
      run: |
        mkdir ./docker/php7.4-fpm/magento
        cp -r ./src/* ./docker/php7.4-fpm/magento/

    - name: Build PHP-FPM (Magento) image
      run: |
        docker build \
          -t $REGISTRY/$PROJECT_ID/techworld-magento:latest \
          ./docker/php7.4-fpm

    - name: Push PHP-FPM image
      run: docker push $REGISTRY/$PROJECT_ID/techworld-magento:latest

    - name: Build Elasticsearch image
      run: |
        docker build \
          -t $REGISTRY/$PROJECT_ID/techworld-elasticsearch:latest \
          ./docker/elasticsearch

    - name: Push Elasticsearch image
      run: docker push $REGISTRY/$PROJECT_ID/techworld-elasticsearch:latest
